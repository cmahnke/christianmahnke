{{ define "title" -}}
  {{- .Title }} Â· {{ .Site.Title -}}
{{- end }}

{{ define "content" }}
  {{- $render := "tag" -}}
  {{- if isset .Params "render" -}}
    {{- $render = printf "tag-%s" (.Params.render) -}}
  {{- end -}}
  {{- partial "header.html" . -}}

    <div class="content-container posts blog">
        {{- partial "section-heading.html" . -}}

        <div class="tag-cloud-container">
          <div class="tag-cloud-control">
            <div class="tag-cloud-activate">{{ i18n "showTagcloud" }}</div>
          </div>
          <div id="tag-cloud" class="tag-cloud background"></div>
          <script type="text/javascript">
            {{- $tags := $.Site.Taxonomies.tags.ByCount -}}
            const tags = [
              {{- range $tags -}}
                {{- if .Term -}}
                  {{- $tagURL := printf "tags/%s" .Term | relURL -}}
                  {{- $tag := .Page.Title -}}
                  {{- $i18nTag := i18n $tag -}}
                  {{- if eq $i18nTag "" -}}
                    {{- $i18nTag = i18n .Term -}}
                  {{- end -}}
                  {{- if eq $i18nTag "" -}}
                    ['{{ $tag }}', {{ .Count | safeJS }}, '{{ "tags/" | relLangURL }}{{ .Term | urlize }}'],
                  {{- else -}}
                    ['{{ $i18nTag }}', {{ .Count | safeJS }}, '{{ "tags/" | relLangURL }}{{ .Term | urlize }}'],
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            ];
            let maxCount = 0;
            tags.map((tag) => {
              const i = tag[1];
              maxCount = Math.max(maxCount, i);
            });
            const template = [ '#ff073a', '#701611']; //Green: '#f1ffb7'
            let colors = chroma.bezier(template);
            colors = chroma.scale(colors).mode('lch').colors(maxCount); //.correctLightness(true);

            const options = {
              list: tags,
              /*
              weightFactor: function (size) {
                return Math.pow(size, 2.3) * $('#canvas').width() / 1024;
              },
              */
              color: function(word, weight, fontSize, distance, theta) {
                const count = tags.find(x => x[0] === word)[1];
                return colors[count - 1];
              },

              click: function(item, dimension, event) {
                console.log(item);
              },
              gridSize: 10,
              weightFactor: 14,
              fontFamily: '"League Spartan", Futura, sans-serif',
              rotateRatio: 0.5,
              rotationSteps: 2,
              classes: 'tag'
            };

            const cloud = document.getElementById('tag-cloud');
            WordCloud(cloud, options);
            /* See https://blog.cubieserver.de/2020/adding-a-tag-cloud-to-my-hugo-blog/ */
            cloud.addEventListener('wordcloudstop', function (e) {
              cloud.classList.add('hidden');
              cloud.classList.remove('background');

              document.querySelectorAll('#tag-cloud .tag').forEach(function (element) {
                const word = element.innerHTML;
                const meta = tags.find(x => x[0] === word);
                const link = meta[2];
                const title = `${word} (${meta[1]})`;
                element.innerHTML = `<a href="${link}" style="color: inherit;" title="${title}">${word}</a>`;
              });
              const handle = cloud.closest('.tag-cloud-container').querySelector('.tag-cloud-activate');
              handle.addEventListener('click', function (e) {
                if (!cloud.classList.contains('show')) {
                  cloud.classList.remove('hidden');
                  cloud.classList.add('show');
                  cloud.classList.remove('hide');
                } else {
                  cloud.classList.remove('show');
                  cloud.classList.add('hide');
                }
              });
            });
          </script>
        </div>

        <div class="posts">
            {{- $pages := where .Site.Pages "Section" "post" -}}
            {{- $mainSite := .Sites.First -}}
            {{- if ne $mainSite .Site -}}
                {{- $pages = ($pages | lang.Merge (where $mainSite.Pages "Section" "post")) -}}
            {{- end -}}

            {{- $paginator := .Paginate (where $pages "Params.displayinlist" "!=" false) -}}
            {{- range $i, $page :=  $paginator.Pages -}}
                {{- .Scratch.Set "class" "odd" -}}
                {{- if modBool $i 2  -}}
                    {{- .Scratch.Set "class" "even" -}}
                {{- end -}}
                {{- partial "li.html" . -}}
            {{- end -}}
        </div>
    </div>
    {{ if or $paginator.HasPrev $paginator.HasNext -}}
      <div class="pagination">
        <div class="pagination-links">
          {{- if $paginator.HasPrev -}}
            <a class="pagination-prev" href="{{ $paginator.Prev.URL }}">&#x25c0;&#xfe0e; {{ i18n "next_page" }}</a>
          {{- else -}}
            <div class="pagination-prev"></div>
          {{- end }}
          {{- if $paginator.HasNext -}}
            <a class="pagination-next" href="{{ $paginator.Next.URL }}">{{ i18n "previous_page" }} &#x25b6;&#xfe0e;</a>
          {{- else -}}
            <div class="pagination-next"></div>
          {{- end -}}
        </div>
      </div>
    {{- end }}

{{ end }}
